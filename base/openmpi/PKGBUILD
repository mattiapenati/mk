#!/bin/bash

pkgname=openmpi
pkgver=2.0.0
archive=$pkgname-$pkgver.tar.bz2
sum=a34f07a0e94af4ccd8080d74827befd61824c6c3
dstdir=$mkToolchainBase

build() {
  download http://www.open-mpi.org/software/ompi/v${pkgver%.*}/downloads/$archive
  check $archive $sum
  extract $archive

  # checking for valgrind
  [[ -x "$mkToolchainBase"/bin/valgrind ]] && \
    with_valgrind="--with-valgrind --enable-memchecker"

  # checking for InfiniBand
  [[ -r "$mkToolchainBase"/lib/libibverbs.so ]] && \
    with_ib="--with-verbs=$mkToolchainBase --enable-openib-rdmacm"

  pushd $pkgname-$pkgver
    message "Configuring $pkgname"
    LIBS=-ldl \
    ./configure --build=$TARGET --prefix="$dstdir" --disable-silent-rules \
                --enable-mpi-fortran=all --enable-ipv6 --without-x \
                --enable-pretty-print-stacktrace $with_valgrind $with_ib \
                --with-hwloc="$mkToolchainBase" \
                --with-libltdl="$mkToolchainBase"
    message "Compiling $pkgname"
    make
  popd
}

package() {
  make -C $pkgname-$pkgver install

  # fix pkg-config
  ln -sf ompi.pc "$dstdir"/lib/pkgconfig/mpi.pc
  ln -sf ompi-c.pc "$dstdir"/lib/pkgconfig/mpi-c.pc
  ln -sf ompi-cxx.pc "$dstdir"/lib/pkgconfig/mpi-cxx.pc
  ln -sf ompi-fort.pc "$dstdir"/lib/pkgconfig/mpi-fort.pc
  ln -sf ompi-f77.pc "$dstdir"/lib/pkgconfig/mpi-f77.pc
  ln -sf ompi-f90.pc "$dstdir"/lib/pkgconfig/mpi-f90.pc
}
