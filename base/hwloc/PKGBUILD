#!/bin/bash

pkgname=hwloc
pkgver=1.11.0
archive=$pkgname-$pkgver.tar.bz2
sum=3ae29c9b0717fa43fe0573f7053e11d766aba73e

dstdir=$mkToolchainBase

build() {
  download http://www.open-mpi.org/software/hwloc/v${pkgver%.*}/downloads/$archive
  check $archive $sum
  extract $archive

  pushd $pkgname-$pkgver
    message "Configuring $pkgname"
    ./configure --build=$TARGET --prefix="$dstdir" --disable-silent-rules \
                --without-x
    message "Compiling $pkgname"
    make
  popd
}

package() {
  make -C $pkgname-$pkgver install
  reset_rpath "$dstdir"/bin/hwloc-{annotate,assembler,bind,calc,diff,distances,distrib,info,patch,ps}
  reset_rpath "$dstdir"/bin/lstopo-no-graphics
  reset_rpath "$dstdir"/lib/libhwloc.so.?.?.?
  strip "$dstdir"/bin/hwloc-{annotate,assembler,bind,calc,diff,distances,distrib,info,patch,ps}
  strip "$dstdir"/bin/lstopo-no-graphics
  strip "$dstdir"/lib/libhwloc.so.?.?.?
  rm -rf "$dstdir"/share/doc
  compress_doc "$dstdir"/share/man/man1/{hwloc,lstopo}*.1
  compress_doc "$dstdir"/share/man/man3/{HWLOC,hwloc}*.3
  compress_doc "$dstdir"/share/man/man7/hwloc.7
  update_linker_cache
}
