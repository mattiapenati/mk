#!/bin/bash

pkgname=metis
pkgver=4
dstdir=$mkToolchainPkgs/$pkgname/$pkgver

parmetisver=3.2.0
parmetisarchive=ParMetis-$parmetisver.tar.gz
parmetisurl=http://glaros.dtc.umn.edu/gkhome/fetch/sw/parmetis/OLD/$parmetisarchive
parmetissum=58c28cc6fb245c27fe942e2626c00bdac5a316b3

build() {
  download $parmetisurl
  check $parmetisarchive $parmetissum
  extract $parmetisarchive

  pushd ParMetis-$parmetisver
    [[ -r $srcdir/ParMetis-$parmetisver.patch ]] && \
      patch -p1 -i $srcdir/ParMetis-$parmetisver.patch
    echo LDFLAGS="$LDFLAGS -L$PWD/../metis-$metisver -lmetis" >> Makefile.in
    message "Compiling parmetis"
    make
  popd
}

package() {
  install -vd $dstdir/{include,lib}

  install -v -m0644 ParMetis-$parmetisver/METISLib/*.h $dstdir/include
  install -v -m0644 ParMetis-$parmetisver/parmetis.h $dstdir/include

  install -v -m0755 ParMetis-$parmetisver/libmetis.so $dstdir/lib/libmetis.so.4
  ln -vs libmetis.so.4 $dstdir/lib/libmetis.so

  install -v -m0755 ParMetis-$parmetisver/libparmetis.so $dstdir/lib/libparmetis.so.3
  ln -vs libparmetis.so.3 $dstdir/lib/libparmetis.so

  # cleaning
  strip $dstdir/lib

  # module
  if [[ "$mkTest" = "no" ]]; then
    install -vd $mkToolchainModules/$pkgname
    cat > $mkToolchainModules/$pkgname/$pkgver.lua << EOF
-- -*- lua -*-
whatis("Serial and parallel graph partitioning and fill-reducing ordering.")
help([[
This package includes both the serial and parallel versions of METIS library,
also known as METIS and ParMETIS respectively. They are install the in the
directory "\$mkMetisPrefix", the dynamic libraries are located in
"\$mkMetisLib" directory and headers files in "\$mkMetisInc".

url: http://glaros.dtc.umn.edu/gkhome/views/metis
]])

setenv("mkMetisPrefix", "$dstdir")
setenv("mkMetisLib", "$dstdir/lib")
setenv("mkMetisInc", "$dstdir/include")

prepend_path("LD_LIBRARY_PATH", "$dstdir/lib")
EOF
  fi
}
